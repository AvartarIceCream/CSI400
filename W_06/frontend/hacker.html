<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Hacker Console</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0e141b;
      --border: #1b2631;
      --text: #cfd8dc;
      --muted: #7a8a98;
      --neo1: #00e676;
      --neo2: #00bcd4
    }

    * {
      box-sizing: border-box
    }

    body.dark {
      margin: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Noto Sans Thai", monospace;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(0, 188, 212, .12), transparent 60%),
        radial-gradient(1000px 700px at 100% 0%, rgba(0, 230, 118, .10), transparent 55%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px
    }

    .frame {
      width: min(1000px, 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(14, 20, 27, .9), rgba(14, 20, 27, .7));
      box-shadow: 0 18px 40px rgba(0, 0, 0, .45);
      overflow: hidden
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(0, 188, 212, .12), rgba(0, 0, 0, 0))
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%
    }

    .r {
      background: #ff5f56
    }

    .y {
      background: #ffbd2e
    }

    .g {
      background: #27c93f
    }

    .title {
      margin-left: 6px;
      color: #a9bdc9;
      font-weight: 600;
      letter-spacing: .3px
    }

    .panel {
      padding: 18px;
      display: grid;
      gap: 14px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      background:
        linear-gradient(180deg, rgba(0, 230, 118, .16), rgba(0, 188, 212, .14));
      color: #e2f1f8;
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 700;
      transition: .2s;
      box-shadow: inset 0 0 0 1px rgba(0, 230, 118, .25), 0 10px 20px rgba(0, 0, 0, .35);
      width: 100%
    }

    .btn:hover {
      filter: brightness(1.05)
    }

    input,
    select {
      padding: 10px;
      border-radius: 8px;
      background: #0a1117;
      border: 1px solid #173042;
      color: #cde8f5;
      outline: none;
      width: 100%
    }

    input:focus {
      box-shadow: 0 0 0 3px rgba(0, 188, 212, .25)
    }

    .inline {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center
    }

    .row {
      display: grid;
      gap: 8px
    }

    .token-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0, 188, 212, .12);
      color: #9fe1ff;
      font-weight: 700;
      font-size: .85rem
    }

    .asset-controls {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
      margin-bottom: 12px
    }

    .asset-controls .row2 {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .asset-controls input {
      flex: 1 1 260px
    }

    .asset-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr))
    }

    .asset-card {
      border-radius: 14px;
      padding: 14px;
      background: rgba(10, 17, 23, .8);
      border: 1px solid #173042;
      color: #cfe6f5;
      display: grid;
      gap: 10px;
      backdrop-filter: blur(6px)
    }

    .asset-card h3 {
      margin: 0
    }

    .asset-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: .88rem;
      opacity: .95
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .78rem;
      font-weight: 700;
      background: rgba(0, 188, 212, .12)
    }

    .badge.type {
      background: rgba(0, 230, 118, .12)
    }

    .badge.author {
      background: rgba(255, 255, 255, .08)
    }

    .asset-desc {
      color: #bcd3e4;
      font-size: .92rem
    }

    .price {
      font-weight: 800;
      font-size: 1.05rem;
      padding: 6px 10px;
      border-radius: 10px;
      width: max-content;
      background: linear-gradient(90deg, rgba(0, 230, 118, .18), rgba(0, 188, 212, .18))
    }

    .group-title {
      margin: 20px 0 8px 0;
      font-weight: 800;
      opacity: .9;
      border-left: 4px solid var(--neo2);
      padding-left: 8px;
      color: #9fe1ff
    }

    .subtle {
      color: #9bb0bd;
      font-size: .85rem
    }

    .switch {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .mono {
      font-family: ui-monospace, Menlo, Consolas, monospace
    }

    pre {
      white-space: pre-wrap;
      background: #0a1117;
      border: 1px solid #173042;
      border-radius: 8px;
      padding: 10px;
      max-height: 300px;
      overflow: auto
    }
  </style>
</head>

<body class="dark">
  <div class="frame">
    <div class="topbar">
      <span class="dot r"></span><span class="dot y"></span><span class="dot g"></span>
      <span class="title">/secure/asset-viewer — hacker mode</span>
    </div>

    <div class="panel">

      <!-- Auth (optional) -->
      <h2 style="margin:0">Auth (optional สำหรับเทส CORS)</h2>
      <div class="row">
        <div class="switch">
          <input type="checkbox" id="use-auth" checked />
          <label for="use-auth" class="subtle">ส่ง Authorization: Bearer &nbsp;<span
              class="mono">(เปิด/ปิดได้)</span></label>
        </div>
        <input id="manual-token" placeholder="ใส่โทเค็นด้วยตัวเอง (จะถูกเก็บใน localStorage[hacker_token])" />
        <div class="inline">
          <button class="btn" id="save-token-btn">Save Token</button>
          <button class="btn" id="clear-token-btn" style="background:rgba(239,83,80,.18)">Clear Token</button>
          <span id="token-status" class="token-pill" style="display:none;"></span>
        </div>
        <p class="subtle">Tip: ตั้งค่าเริ่มต้นผ่าน URL ได้ เช่น <span class="mono">?token=xxx&useAuth=0</span></p>
      </div>

      <!-- API controls -->
      <h2 style="margin:8px 0 0 0">เรียก API</h2>
      <div class="inline">
        <button class="btn" onclick="runRequest('all')">GET /getAsset</button>
      </div>
      <input id="in-username" placeholder="username" />
      <button class="btn" onclick="runRequest('username')">/getAsset/:username</button>
      <input id="in-min" placeholder="minimum price" />
      <button class="btn" onclick="runRequest('min')">/getAsset/minimum/:price</button>
      <input id="in-ctg" placeholder="category" />
      <button class="btn" onclick="runRequest('ctg')">/getAsset/category/:ctg</button>
      <input id="in-ctg2" placeholder="category" />
      <input id="in-type2" placeholder="type" />
      <button class="btn" onclick="runRequest('ctgtype')">/getAsset/category/:ctg/:type</button>

      <!-- Search + KPI -->
      <div class="asset-controls">
        <div class="row2">
          <input id="q-search" placeholder="ค้นหาชื่อหรือคำอธิบาย (search)" />
        </div>
        <div class="kpi" id="kpi"></div>
      </div>

      <!-- View -->
      <div id="asset-container"></div>

      <!-- Raw result (ช่วยเทส CORS / header) -->
      <h3 style="margin:0">Raw Response</h3>
      <pre id="raw"></pre>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api/private';
    const TOKEN_KEY = 'hacker_token';

    const el = (id) => document.getElementById(id);
    const qs = new URLSearchParams(location.search);

    // ----- Token helpers -----
    const getToken = () => localStorage.getItem(TOKEN_KEY) || '';
    const setToken = (t) => { localStorage.setItem(TOKEN_KEY, t); paintToken() };
    const clearToken = () => { localStorage.removeItem(TOKEN_KEY); paintToken() };

    // init from query string
    (function initFromQS() {
      const t = qs.get('token'); if (t) setToken(t);
      const ua = qs.get('useAuth'); if (ua === '0' || ua === 'false') el('use-auth').checked = false;
    })();

    // UI: save/clear token
    el('manual-token').value = getToken();
    el('save-token-btn').addEventListener('click', () => {
      setToken(el('manual-token').value.trim());
      alert('Saved token แล้ว');
    });
    el('clear-token-btn').addEventListener('click', () => {
      clearToken();
      el('manual-token').value = '';
      alert('ลบ token ใน localStorage แล้ว');
    });

    function paintToken() {
      const t = getToken(), s = el('token-status');
      if (t) {
        const short = t.length > 16 ? t.slice(0, 8) + '...' + t.slice(-6) : t;
        s.textContent = 'Token: ' + short; s.style.display = 'inline-block';
      } else { s.textContent = ''; s.style.display = 'none' }
    }

    // ----- Request core (ส่งแบบมี/ไม่มี Authorization ได้) -----
    async function request(path) {
      const headers = {};
      if (el('use-auth').checked) {
        const tk = getToken();
        if (!tk) console.warn('use-auth เปิดอยู่ แต่ไม่มี token ใน localStorage');
        headers['Authorization'] = `Bearer ${tk || ''}`;
      }
      // ช่วยดู CORS: โชว์ผลทั้ง status/headers/body
      const url = `${API_BASE}${path}`;
      let res, text;
      try {
        res = await fetch(url, { method: 'GET', credentials: 'include', headers });
        text = await res.text();
      } catch (err) {
        el('raw').textContent = `FETCH ERROR:\n${err?.message || err}`;
        throw err;
      }

      // แสดง raw
      try {
        const hdrs = [...res.headers.entries()].map(([k, v]) => `${k}: ${v}`).join('\n');
        el('raw').textContent =
          `URL: ${url}
Status: ${res.status} ${res.statusText}
${hdrs ? '--- Headers ---\n' + hdrs + '\n' : ''}--- Body ---
${text}`;
      } catch (_) { /* ignore */ }

      try { return JSON.parse(text) } catch { return text }
    }

    // ----- API shortcuts -----
    const getAll = () => request('/getAsset');
    const getByUsername = (u) => request(`/getAsset/${encodeURIComponent(u)}`);
    const getByMinPrice = (p) => request(`/getAsset/minimum/${encodeURIComponent(p)}`);
    const getByCategory = (c) => request(`/getAsset/category/${encodeURIComponent(c)}`);
    const getByCategoryType = (c, t) => request(`/getAsset/category/${encodeURIComponent(c)}/${encodeURIComponent(t)}`);

    // ----- Render helpers -----
    const NF_THB = new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 });
    let ORIGINAL_DATA = []; let FILTER_WIRED = false;
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

    function filterBySearch(d) {
      const q = el('q-search').value.trim().toLowerCase();
      return d.filter(x => {
        const hay = (x.name + ' ' + (x.description || '')).toLowerCase();
        return !q || hay.includes(q);
      });
    }
    function groupByCategory(items) { const g = {}; for (const it of items) { (g[it.category] ??= []).push(it) } return g }

    function renderGrid(items) {
      const wrap = el('asset-container');
      if (!items.length) { wrap.innerHTML = '<div class="subtle">ไม่พบข้อมูลที่ตรงเงื่อนไข</div>'; return }
      const groups = groupByCategory(items); const order = Object.keys(groups).sort(); let html = '';
      for (const ctg of order) {
        html += `<h3 class="group-title">${ctg}</h3><div class="asset-grid">`;
        html += groups[ctg].map(it => `
          <article class="asset-card">
            <h3>${escapeHtml(it.name)}</h3>
            <div class="asset-meta">
              <span class="badge">${escapeHtml(it.category)}</span>
              <span class="badge type">${escapeHtml(it.type)}</span>
              <span class="badge author">@${escapeHtml(it.author)}</span>
              <span class="price">฿${NF_THB.format(+it.price || 0)}</span>
            </div>
            <p class="asset-desc">${escapeHtml(it.description || '')}</p>
            <div class="subtle">#${it.id}</div>
          </article>`).join('');
        html += '</div>';
      }
      wrap.innerHTML = html;
    }

    function renderKPI(items) {
      const k = el('kpi');
      if (!items.length) { k.textContent = 'รายการ: 0'; return }
      const total = items.reduce((s, x) => s + (+x.price || 0), 0);
      const min = Math.min(...items.map(x => +x.price || 0));
      const max = Math.max(...items.map(x => +x.price || 0));
      k.innerHTML =
        `<span>รายการ: ${items.length}</span>
         <span>ราคารวม: ฿${NF_THB.format(total)}</span>
         <span>ต่ำสุด: ฿${NF_THB.format(min)}</span>
         <span>สูงสุด: ฿${NF_THB.format(max)}</span>`;
    }

    function wireFilterEvents() {
      if (FILTER_WIRED) return; FILTER_WIRED = true;
      el('q-search').addEventListener('input', () => {
        const f = filterBySearch(ORIGINAL_DATA);
        renderKPI(f); renderGrid(f);
      });
    }

    function renderAssets(arr) {
      ORIGINAL_DATA = Array.isArray(arr) ? arr.slice() : [];
      wireFilterEvents();
      const f = filterBySearch(ORIGINAL_DATA);
      renderKPI(f); renderGrid(f);
    }

    // ----- Action handlers -----
    async function runRequest(kind) {
      try {
        if (kind === 'all') { const r = await getAll(); return renderAssets(r.data ?? r) }
        if (kind === 'username') { const v = el('in-username').value.trim(); const r = await getByUsername(v); return renderAssets(r.data ?? r) }
        if (kind === 'min') { const v = el('in-min').value.trim(); const r = await getByMinPrice(v); return renderAssets(r.data ?? r) }
        if (kind === 'ctg') { const v = el('in-ctg').value.trim(); const r = await getByCategory(v); return renderAssets(r.data ?? r) }
        if (kind === 'ctgtype') { const c = el('in-ctg2').value.trim(); const t = el('in-type2').value.trim(); const r = await getByCategoryType(c, t); return renderAssets(r.data ?? r) }
      } catch (e) {
        console.error(e);
        // raw panel จะโชว์ error ของ fetch แล้ว ถ้าต้องการ popup ด้วยก็:
        alert(e.message);
      }
    }

    window.addEventListener('DOMContentLoaded', paintToken);
  </script>
</body>

</html>