<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Bank B</title>
  <style>
    :root {
      --bg: #f4fff7;
      --card: #ffffff;
      --primary: #2e7d32;
      --primary-600: #1b5e20;
      --text: #102a13;
      --muted: #5a6b5e;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, "Noto Sans Thai", sans-serif;
      background:
        radial-gradient(1200px 800px at 15% -10%, #e8f5e9, transparent 60%),
        radial-gradient(1000px 700px at 100% 0%, #c8e6c9, transparent 55%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .shell {
      width: min(1000px, 100%);
      display: grid;
      gap: 16px
    }

    h1 {
      margin: 0;
      color: var(--primary-600);
      font-size: 1.25rem
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 22px;
      border: 1px solid rgba(27, 94, 32, .08);
      box-shadow: 0 12px 30px rgba(16, 42, 19, .08)
    }

    .muted {
      color: var(--muted);
      font-size: .9rem
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    input {
      padding: 10px;
      border-radius: 999px;
      border: 1px solid #cfe9d1;
      background: #fff;
      outline: none;
      width: 100%
    }

    button {
      padding: 10px 16px;
      border: 0;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      color: #fff;
      font-weight: 700;
      letter-spacing: .2px;
      box-shadow: 0 8px 20px rgba(46, 125, 50, .3);
      transition: .2s;
      width: 100%;
    }

    button:hover {
      filter: brightness(1.05)
    }

    .inline {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .token-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: #eaf7ec;
      color: #1b5e20;
      font-weight: 700;
      font-size: .85rem
    }

    /* asset view */
    .asset-controls {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr;
      margin-bottom: 12px
    }

    .asset-controls .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .asset-controls input {
      flex: 1 1 260px
    }

    .asset-controls .kpi {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-weight: 600;
      opacity: .9
    }

    .asset-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr))
    }

    .asset-card {
      border-radius: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, .9);
      border: 1px solid rgba(27, 94, 32, .15);
      box-shadow: 0 10px 20px rgba(0, 0, 0, .06);
      display: grid;
      gap: 10px
    }

    .asset-card h3 {
      margin: 0;
      font-size: 1.05rem
    }

    .asset-meta {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: .88rem;
      opacity: .9
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .78rem;
      font-weight: 700;
      background: rgba(0, 0, 0, .06)
    }

    .badge.ctg {
      background: rgba(76, 175, 80, .12)
    }

    .badge.type {
      background: rgba(56, 142, 60, .12)
    }

    .badge.author {
      background: rgba(120, 120, 120, .12)
    }

    .asset-desc {
      color: #415a4a;
      font-size: .92rem
    }

    .price {
      font-weight: 800;
      font-size: 1.05rem;
      padding: 6px 10px;
      border-radius: 10px;
      width: max-content;
      background: rgba(255, 193, 7, .15)
    }

    .group-title {
      margin: 20px 0 8px 0;
      font-weight: 800;
      opacity: .8;
      border-left: 4px solid currentColor;
      padding-left: 8px
    }

    body:has(.asset-grid) .asset-card {
      backdrop-filter: blur(6px)
    }
  </style>
</head>

<body>
  <main class="shell">
    <h1>Bank B · Secure Asset Viewer</h1>

    <!-- Login -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;">เข้าสู่ระบบ</h2>
      <p class="muted">โทเค็นจะถูกเก็บไว้ที่ <code>localStorage["bankB_token"]</code></p>
      <div class="actions">
        <input id="login-username" placeholder="username" />
        <input id="login-password" type="password" placeholder="password" />
        <input id="login-endpoint" placeholder="Login Endpoint" value="http://localhost:3000/api/auth/login" />
        <button onclick="login()">Login & Save Token</button>
        <div class="inline">
          <button style="background:#ef5350" onclick="logout()">Logout / Clear Token</button>
          <span id="token-status" class="token-pill" style="display:none;"></span>
        </div>
      </div>
    </section>

    <!-- API -->
    <section class="card">
      <h2 style="margin:0 0 8px 0;">เรียก API</h2>
      <div class="actions">
        <button onclick="runRequest('all')">GET /getAsset</button>
        <input id="in-username" placeholder="username" />
        <button onclick="runRequest('username')">/getAsset/:username</button>
        <input id="in-min" placeholder="minimum price" />
        <button onclick="runRequest('min')">/getAsset/minimum/:price</button>
        <input id="in-ctg" placeholder="category" />
        <button onclick="runRequest('ctg')">/getAsset/category/:ctg</button>
        <input id="in-ctg2" placeholder="category" />
        <input id="in-type2" placeholder="type" />
        <button onclick="runRequest('ctgtype')">/getAsset/category/:ctg/:type</button>
      </div>
    </section>

    <!-- View -->
    <section class="card">
      <div class="asset-controls">
        <div class="row">
          <!-- เหลือเฉพาะช่อง search -->
          <input id="q-search" placeholder="ค้นหาชื่อหรือคำอธิบาย (search)" />
        </div>
        <div class="kpi" id="kpi"></div>
      </div>
      <div id="asset-container"></div>
    </section>
  </main>

  <script>
    const API_BASE = 'http://localhost:3000/api/private';
    const TOKEN_KEY = 'bankB_token';

    function getToken() { return localStorage.getItem(TOKEN_KEY) || '' }
    function setToken(t) { localStorage.setItem(TOKEN_KEY, t); paintToken() }
    function clearToken() { localStorage.removeItem(TOKEN_KEY); paintToken() }

    async function login() {
      const u = login_username.value.trim();
      const p = login_password.value;
      const endpoint = login_endpoint.value.trim() || 'http://localhost:3000/api/auth/login';
      if (!u || !p) return alert('กรอก username/password');
      try {
        const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
        if (!res.ok) throw new Error('Login failed: ' + await res.text());
        const data = await res.json();
        if (!data.token) throw new Error('ไม่มี token ในผลลัพธ์');
        setToken(data.token); alert('Login สำเร็จ!');
      } catch (e) { console.error(e); alert(e.message) }
    }
    function logout() { clearToken(); alert('เคลียร์โทเค็นแล้ว') }

    function paintToken() {
      const t = getToken(), el = token_status;
      if (t) { const short = t.length > 16 ? t.slice(0, 8) + '...' + t.slice(-6) : t; el.textContent = 'Token: ' + short; el.style.display = 'inline-block' }
      else { el.textContent = ''; el.style.display = 'none' }
    }

    async function request(path) {
      const token = getToken(); if (!token) throw new Error('ยังไม่ได้ Login');
      const res = await fetch(`${API_BASE}${path}`, { method: 'GET', credentials: 'include', headers: { 'Authorization': `Bearer ${token}` } });
      const tx = await res.text(); try { return JSON.parse(tx) } catch { return tx }
    }
    const getAll = () => request('/getAsset');
    const getByUsername = u => request(`/getAsset/${encodeURIComponent(u)}`);
    const getByMinPrice = p => request(`/getAsset/minimum/${encodeURIComponent(p)}`);
    const getByCategory = c => request(`/getAsset/category/${encodeURIComponent(c)}`);
    const getByCategoryType = (c, t) => request(`/getAsset/category/${encodeURIComponent(c)}/${encodeURIComponent(t)}`);

    const NF_THB = new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 });
    let ORIGINAL_DATA = []; let FILTER_WIRED = false;
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

    function filterBySearch(d) {
      const q = q_search.value.trim().toLowerCase();
      return d.filter(x => {
        const hay = (x.name + ' ' + (x.description || '')).toLowerCase();
        return !q || hay.includes(q);
      });
    }
    function groupByCategory(items) { const g = {}; for (const it of items) { (g[it.category] ??= []).push(it) } return g }
    function renderGrid(items) {
      if (!items.length) { asset_container.innerHTML = '<div class="muted">ไม่พบข้อมูล</div>'; return }
      const groups = groupByCategory(items); const order = Object.keys(groups).sort(); let html = '';
      for (const ctg of order) {
        html += `<h3 class="group-title">${ctg}</h3><div class="asset-grid">`;
        html += groups[ctg].map(it => `
          <article class="asset-card">
            <h3>${escapeHtml(it.name)}</h3>
            <div class="asset-meta">
              <span class="badge ctg">${escapeHtml(it.category)}</span>
              <span class="badge type">${escapeHtml(it.type)}</span>
              <span class="badge author">@${escapeHtml(it.author)}</span>
              <span class="price">฿${NF_THB.format(it.price)}</span>
            </div>
            <p class="asset-desc">${escapeHtml(it.description || '')}</p>
            <div class="muted">#${it.id}</div>
          </article>
        `).join('');
        html += '</div>';
      }
      asset_container.innerHTML = html;
    }
    function renderKPI(items) {
      if (!items.length) { kpi.textContent = 'รายการ: 0'; return }
      const total = items.reduce((s, x) => s + (+x.price || 0), 0), min = Math.min(...items.map(x => x.price)), max = Math.max(...items.map(x => x.price));
      kpi.innerHTML = `<span>รายการ: ${items.length}</span><span>ราคารวม: ฿${NF_THB.format(total)}</span><span>ต่ำสุด: ฿${NF_THB.format(min)}</span><span>สูงสุด: ฿${NF_THB.format(max)}</span>`;
    }
    function wireFilterEvents() {
      if (FILTER_WIRED) return; FILTER_WIRED = true;
      q_search.addEventListener('input', () => { const f = filterBySearch(ORIGINAL_DATA); renderKPI(f); renderGrid(f) })
    }
    function renderAssets(arr) {
      ORIGINAL_DATA = Array.isArray(arr) ? arr.slice() : [];
      wireFilterEvents();
      const f = filterBySearch(ORIGINAL_DATA); renderKPI(f); renderGrid(f);
    }

    async function runRequest(kind) {
      try {
        if (kind === 'all') { const r = await getAll(); return renderAssets(r.data ?? r) }
        if (kind === 'username') { const r = await getByUsername(in_username.value.trim()); return renderAssets(r.data ?? r) }
        if (kind === 'min') { const r = await getByMinPrice(in_min.value.trim()); return renderAssets(r.data ?? r) }
        if (kind === 'ctg') { const r = await getByCategory(in_ctg.value.trim()); return renderAssets(r.data ?? r) }
        if (kind === 'ctgtype') { const r = await getByCategoryType(in_ctg2.value.trim(), in_type2.value.trim()); return renderAssets(r.data ?? r) }
      } catch (e) { console.error(e); alert(e.message) }
    }

    window.addEventListener('DOMContentLoaded', paintToken);
  </script>
</body>

</html>